#!/usr/bin/env python3
"""
Test Principal - ICT Engine v6.1.0 Enterprise SIC
===============================================

Script de test completo para verificar el funcionamiento del
Sistema de Imports Inteligente (SIC) v3.1 Enterprise.

Este script ejecuta tests exhaustivos de todos los componentes:
- SIC v3.1 Enterprise Interface
- Lazy Loading Manager
- Predictive Cache Manager
- Monitor Dashboard
- Advanced Debugger

Autor: ICT Engine v6.1.0 Team
Versi√≥n: v6.1.0-enterprise
Fecha: Agosto 2025
"""

import sys
import time
import traceback
from pathlib import Path

# Agregar el directorio del proyecto al path para imports
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

def test_sic_enterprise_interface():
    """üöÄ Test del SIC v3.1 Enterprise Interface"""
    print("\n" + "="*60)
    print("üöÄ TESTING SIC v3.1 ENTERPRISE INTERFACE")
    print("="*60)
    
    try:
        # Import del SIC
        from sistema.sic_v3_1 import get_sic_instance, smart_import
        
        print("1Ô∏è‚É£ Inicializando SIC v3.1 Enterprise...")
        sic = get_sic_instance()
        print("   ‚úÖ SIC inicializado correctamente")
        
        print("2Ô∏è‚É£ Testing smart import b√°sico...")
        sys_module = smart_import('sys')
        print(f"   ‚úÖ Smart import exitoso: {type(sys_module)}")
        
        print("3Ô∏è‚É£ Testing smart import con alias...")
        os_module = smart_import('os', alias='operating_system')
        print("   ‚úÖ Smart import con alias exitoso")
        
        print("4Ô∏è‚É£ Testing smart import lazy...")
        time_module = smart_import('time', priority='low')
        print("   ‚úÖ Smart import lazy exitoso")
        
        print("5Ô∏è‚É£ Obteniendo estad√≠sticas del sistema...")
        stats = sic.get_system_stats()
        print(f"   ‚úÖ Estad√≠sticas: {stats['imports_stats']['total_imports']} imports realizados")
        print(f"   üìä Cache hit rate: {stats['imports_stats']['cache_hit_rate']:.1f}%")
        print(f"   ‚è±Ô∏è Tiempo promedio: {stats['imports_stats']['avg_load_time']:.4f}s")
        
        print("6Ô∏è‚É£ Testing reporte de debug...")
        debug_report = sic.get_debug_report()
        print(f"   ‚úÖ Reporte de debug generado: {len(debug_report)} secciones")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def test_lazy_loading_manager():
    """üîÑ Test del Lazy Loading Manager"""
    print("\n" + "="*60)
    print("üîÑ TESTING LAZY LOADING MANAGER")
    print("="*60)
    
    try:
        from sistema.sic_v3_1.lazy_loading import LazyLoadingManager
        
        print("1Ô∏è‚É£ Inicializando Lazy Loading Manager...")
        lazy_manager = LazyLoadingManager()
        print("   ‚úÖ Lazy Manager inicializado")
        
        print("2Ô∏è‚É£ Testing lazy import...")
        json_proxy = lazy_manager.lazy_import('json')
        print(f"   ‚úÖ Proxy creado: {json_proxy}")
        print(f"   üìä ¬øEst√° cargado? {json_proxy.is_loaded}")
        
        print("3Ô∏è‚É£ Accediendo al m√≥dulo lazy (deber√≠a cargarlo)...")
        json_dumps = json_proxy.dumps
        print(f"   ‚úÖ M√≥dulo accedido: {json_dumps}")
        print(f"   üìä ¬øEst√° cargado ahora? {json_proxy.is_loaded}")
        print(f"   ‚è±Ô∏è Tiempo de carga: {json_proxy.load_time:.4f}s")
        
        print("4Ô∏è‚É£ Testing estad√≠sticas de lazy loading...")
        stats = lazy_manager.get_lazy_stats()
        print(f"   ‚úÖ Stats obtenidas: {stats['module_stats']['total_lazy_modules']} m√≥dulos lazy")
        
        print("5Ô∏è‚É£ Testing cleanup de proxies...")
        cleaned = lazy_manager.cleanup_unused_proxies()
        print(f"   ‚úÖ Cleanup completado: {cleaned} proxies eliminados")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def test_predictive_cache_manager():
    """üß† Test del Predictive Cache Manager"""
    print("\n" + "="*60)
    print("üß† TESTING PREDICTIVE CACHE MANAGER")
    print("="*60)
    
    try:
        from sistema.sic_v3_1.predictive_cache import PredictiveCacheManager
        
        print("1Ô∏è‚É£ Inicializando Predictive Cache Manager...")
        cache_manager = PredictiveCacheManager()
        print("   ‚úÖ Cache Manager inicializado")
        
        print("2Ô∏è‚É£ Testing cache de m√≥dulo...")
        import math
        cached = cache_manager.cache_module('math', module_obj=math)
        print(f"   ‚úÖ M√≥dulo cacheado: {cached}")
        
        print("3Ô∏è‚É£ Testing obtenci√≥n desde cache...")
        cached_math = cache_manager.get_cached_module('math')
        print(f"   ‚úÖ Cache hit: {cached_math is not None}")
        
        print("4Ô∏è‚É£ Testing cache miss...")
        missing_module = cache_manager.get_cached_module('nonexistent_module')
        print(f"   ‚úÖ Cache miss: {missing_module is None}")
        
        print("5Ô∏è‚É£ Testing predicciones...")
        predictions = cache_manager.predict_next_modules('math', count=3)
        print(f"   ‚úÖ Predicciones generadas: {len(predictions)} m√≥dulos predichos")
        
        print("6Ô∏è‚É£ Testing estad√≠sticas de cache...")
        stats = cache_manager.get_cache_stats()
        hit_rate = stats['cache_performance']['hit_rate_percent']
        print(f"   ‚úÖ Stats: {hit_rate:.1f}% hit rate")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def test_monitor_dashboard():
    """üìä Test del Monitor Dashboard"""
    print("\n" + "="*60)
    print("üìä TESTING MONITOR DASHBOARD")
    print("="*60)
    
    try:
        from sistema.sic_v3_1.monitor_dashboard import MonitorDashboard
        
        print("1Ô∏è‚É£ Inicializando Monitor Dashboard...")
        monitor = MonitorDashboard()
        print("   ‚úÖ Monitor inicializado")
        
        print("2Ô∏è‚É£ Testing registro de eventos...")
        event_id = monitor.record_import(
            module_name='test_module',
            load_time=0.005,
            import_type='normal',
            success=True
        )
        print(f"   ‚úÖ Evento registrado: {event_id}")
        
        print("3Ô∏è‚É£ Testing estad√≠sticas en tiempo real...")
        real_time_stats = monitor.get_real_time_stats()
        print(f"   ‚úÖ Stats obtenidas: {real_time_stats['import_stats']['total_imports']} imports")
        
        print("4Ô∏è‚É£ Testing an√°lisis de tendencias...")
        trends = monitor.get_trend_analysis(hours=0.1)
        print(f"   ‚úÖ An√°lisis de tendencias generado")
        
        print("5Ô∏è‚É£ Testing generaci√≥n de reporte...")
        report = monitor.generate_report(format='text')
        print(f"   ‚úÖ Reporte generado: {len(report)} caracteres")
        
        # Cleanup
        monitor.shutdown()
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def test_advanced_debugger():
    """üîß Test del Advanced Debugger"""
    print("\n" + "="*60)
    print("üîß TESTING ADVANCED DEBUGGER")
    print("="*60)
    
    try:
        from sistema.sic_v3_1.advanced_debug import AdvancedDebugger
        
        print("1Ô∏è‚É£ Inicializando Advanced Debugger...")
        debugger = AdvancedDebugger()
        print("   ‚úÖ Debugger inicializado")
        
        print("2Ô∏è‚É£ Testing log de import debug...")
        debugger.log_import_debug(
            module_name='test_module',
            import_type='normal',
            operation='load',
            duration=0.003,
            success=True,
            details={'test_data': 'example'}
        )
        print("   ‚úÖ Debug log registrado")
        
        print("3Ô∏è‚É£ Testing an√°lisis de dependencias...")
        dep_analysis = debugger.analyze_import_dependencies('sys')
        print(f"   ‚úÖ An√°lisis completado: {len(dep_analysis)} items")
        
        print("4Ô∏è‚É£ Testing diagn√≥stico de error...")
        test_error = ImportError("Test error for diagnosis")
        diagnosis = debugger.diagnose_import_problem('fake_module', test_error)
        print(f"   ‚úÖ Diagn√≥stico: {len(diagnosis['possible_causes'])} causas identificadas")
        
        print("5Ô∏è‚É£ Testing resumen de debug...")
        summary = debugger.get_debug_summary()
        print(f"   ‚úÖ Resumen: {summary['debug_stats']['total_events']} eventos")
        
        print("6Ô∏è‚É£ Testing reporte completo...")
        full_report = debugger.generate_full_report()
        print(f"   ‚úÖ Reporte completo: {len(full_report)} secciones")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def test_integration():
    """üîó Test de integraci√≥n completa"""
    print("\n" + "="*60)
    print("üîó TESTING INTEGRACI√ìN COMPLETA")
    print("="*60)
    
    try:
        from sistema import get_sic_instance, smart_import
        
        print("1Ô∏è‚É£ Inicializando sistema completo...")
        sic = get_sic_instance()
        print("   ‚úÖ Sistema inicializado")
        
        print("2Ô∏è‚É£ Testing secuencia de imports inteligentes...")
        
        # Import normal
        datetime_module = smart_import('datetime')
        print("   ‚úÖ Import normal: datetime")
        
        # Import con cache (deber√≠a ser hit)
        datetime_cached = smart_import('datetime')
        print("   ‚úÖ Import cacheado: datetime")
        
        # Import lazy
        random_module = smart_import('random', priority='low')
        print("   ‚úÖ Import lazy: random")
        
        # Import con from
        sleep_func = smart_import('time', from_list=['sleep'])
        print("   ‚úÖ Import espec√≠fico: time.sleep")
        
        print("3Ô∏è‚É£ Verificando estad√≠sticas finales...")
        final_stats = sic.get_system_stats()
        imports_stats = final_stats['imports_stats']
        
        print(f"   üìä Total imports: {imports_stats['total_imports']}")
        print(f"   üìä Cache hits: {imports_stats['cache_hits']}")
        print(f"   üìä Cache hit rate: {imports_stats['cache_hit_rate']:.1f}%")
        print(f"   üìä Tiempo promedio: {imports_stats['avg_load_time']:.4f}s")
        
        # Verificar que el sistema est√© funcionando correctamente
        assert imports_stats['total_imports'] > 0, "No se registraron imports"
        assert imports_stats['cache_hit_rate'] >= 0, "Cache hit rate inv√°lido"
        
        print("4Ô∏è‚É£ Testing debug mode...")
        sic.enable_debug_mode('debug')
        print("   ‚úÖ Debug mode activado")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def run_performance_benchmark():
    """‚ö° Benchmark de performance"""
    print("\n" + "="*60)
    print("‚ö° BENCHMARK DE PERFORMANCE")
    print("="*60)
    
    try:
        from sistema import smart_import
        import time
        
        # Test 1: Import normal vs smart import
        print("1Ô∏è‚É£ Comparando import normal vs smart import...")
        
        # Import normal tradicional
        start_time = time.time()
        import collections
        normal_time = time.time() - start_time
        
        # Smart import
        start_time = time.time()
        collections_smart = smart_import('collections')
        smart_time = time.time() - start_time
        
        print(f"   üìä Import normal: {normal_time:.6f}s")
        print(f"   üìä Smart import: {smart_time:.6f}s")
        
        # Test 2: Cache performance
        print("2Ô∏è‚É£ Testing performance de cache...")
        
        start_time = time.time()
        for i in range(10):
            smart_import('collections')  # Deber√≠a ser cache hit
        cache_time = (time.time() - start_time) / 10
        
        print(f"   üìä Promedio cache hit: {cache_time:.6f}s")
        
        # Test 3: Lazy loading overhead
        print("3Ô∏è‚É£ Testing overhead de lazy loading...")
        
        start_time = time.time()
        lazy_module = smart_import('urllib.parse', priority='low')
        lazy_create_time = time.time() - start_time
        
        start_time = time.time()
        _ = lazy_module.urlparse  # Forzar carga
        lazy_load_time = time.time() - start_time
        
        print(f"   üìä Lazy proxy creation: {lazy_create_time:.6f}s")
        print(f"   üìä Lazy actual load: {lazy_load_time:.6f}s")
        
        assert True
        
    except Exception as e:
        print(f"   ‚ùå ERROR: {e}")
        traceback.print_exc()
        return False


def main():
    """üéØ Funci√≥n principal de test"""
    print("üöÄ ICT ENGINE v6.0 ENTERPRISE SIC - TEST SUITE")
    print("=" * 80)
    print(f"Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Python: {sys.version}")
    print("=" * 80)
    
    # Lista de tests a ejecutar
    tests = [
        ("SIC Enterprise Interface", test_sic_enterprise_interface),
        ("Lazy Loading Manager", test_lazy_loading_manager),
        ("Predictive Cache Manager", test_predictive_cache_manager),
        ("Monitor Dashboard", test_monitor_dashboard),
        ("Advanced Debugger", test_advanced_debugger),
        ("Integraci√≥n Completa", test_integration),
        ("Performance Benchmark", run_performance_benchmark),
    ]
    
    # Ejecutar tests
    results = []
    total_start_time = time.time()
    
    for test_name, test_func in tests:
        print(f"\nüß™ Ejecutando: {test_name}...")
        start_time = time.time()
        
        try:
            result = test_func()
            duration = time.time() - start_time
            results.append((test_name, result, duration))
            
            status = "‚úÖ PASSED" if result else "‚ùå FAILED"
            print(f"   {status} ({duration:.2f}s)")
            
        except Exception as e:
            duration = time.time() - start_time
            results.append((test_name, False, duration))
            print(f"   ‚ùå ERROR: {e} ({duration:.2f}s)")
    
    # Resumen final
    total_duration = time.time() - total_start_time
    passed = sum(1 for _, result, _ in results if result)
    total = len(results)
    
    print("\n" + "=" * 80)
    print("üìã RESUMEN DE TESTS")
    print("=" * 80)
    
    for test_name, result, duration in results:
        status = "‚úÖ PASSED" if result else "‚ùå FAILED"
        print(f"{status} {test_name:<30} ({duration:.2f}s)")
    
    print("-" * 80)
    print(f"üìä RESULTADO FINAL: {passed}/{total} tests pasaron")
    print(f"‚è±Ô∏è TIEMPO TOTAL: {total_duration:.2f}s")
    
    if passed == total:
        print("üéâ ¬°TODOS LOS TESTS PASARON! SIC v3.1 Enterprise est√° funcionando correctamente.")
    else:
        print("‚ö†Ô∏è Algunos tests fallaron. Revisar los errores arriba.")
    
    print("=" * 80)
    
    return passed == total


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
